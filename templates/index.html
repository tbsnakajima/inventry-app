<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>在庫管理</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { font-size: 16px; padding: 5px 10px; margin: 2px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 16px; }
        th { background-color: #eee; }
        .btn { background: #2a7ae2; color: white; border: none; border-radius: 6px; }
        .btn-red { background: #e02a2a; color: white; border: none; border-radius: 6px; }
    </style>
</head>
<body>

<h2>在庫一覧 ({{ user }} / {{ role }})</h2>

<table id="stockTable"></table>

<a href="/logout">ログアウト</a>

<script>
async function loadStock() {
    const res = await fetch("/stock");
    const data = await res.json();
    const table = document.getElementById("stockTable");

    // ヘッダー
    table.innerHTML = `
        <tr>
            <th>品目ID</th>
            <th>品名</th>
            <th>数量</th>
            <th>発注フラグ</th>
            <th>操作</th>
        </tr>
    `;

    data.forEach(row => {
        const flag = row.reorder_flag ? "⚠ 発注必要" : "";
        let actions = "";

    const role = '{{ role|safe }}'; // Flask側の role を正しく文字列として取得

          if(role === "owner" || role === "manager") {
          actions = `
         <button class="btn" onclick="stockIn('${row.item}')">入庫</button>
         <button class="btn btn-red" onclick="stockOut('${row.item}')">出庫</button>
         `;
         } else if(role === "staff") {
          actions = `<button class="btn btn-red" onclick="stockOut('${row.item}')">出庫</button>`;
}


        table.innerHTML += `
            <tr>
                <td>${row.item}</td>
                <td>${row.name || ""}</td>
                <td>${row.qty}</td>
                <td style="color:red">${flag}</td>
                <td>
                    <button class="btn" onclick="stockIn('${row.item}')">入庫</button>
                    <button class="btn btn-red" onclick="stockOut('${row.item}')">出庫</button>
                </td>

            </tr>
        `;
    });
}

// 行ボタン用の入出庫処理
async function stockIn(item) {
    const qty = prompt("入庫数量を入力");
    if(qty){
        await fetch("/stock/in", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({item:item, qty:parseInt(qty)})
        });
        loadStock();
    }
}

async function stockOut(item) {
    const qty = prompt("出庫数量を入力");
    if(qty){
        await fetch("/stock/out", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({item:item, qty:parseInt(qty)})
        });
        loadStock();
    }
}

// ページ読み込み時に在庫データ取得
window.onload = loadStock;
</script>

</body>
</html>
