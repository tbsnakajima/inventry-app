<!DOCTYPE html>
<html>
<head>
    <title>在庫管理</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

    <h3>新しい商品を追加</h3>
<form id="add-item-form">
    <input type="text" name="item_name" placeholder="商品名" required>
    <input type="text" name="category" placeholder="カテゴリー">
    <input type="text" name="unit" placeholder="単位">
    <input type="number" name="reorder_point" placeholder="発注点" min="0">
    <input type="number" name="standard_price" placeholder="標準単価" step="0.01">
    <button type="submit">追加</button>
</form>

<script>
document.getElementById('add-item-form').addEventListener('submit', function(e){
    e.preventDefault();
    const form = e.target;
    const data = {
        item_name: form.item_name.value,
        category: form.category.value,
        unit: form.unit.value,
        reorder_point: parseInt(form.reorder_point.value) || 0,
        standard_price: parseFloat(form.standard_price.value) || 0
    };
    axios.post('/item/add', data)
        .then(res => {
            if(res.data.status === "ok"){
                alert("商品追加成功");
                form.reset();
                loadStock();  // 在庫一覧更新
            }
        });
});
</script>


<h1>在庫管理</h1>

<table border="1">
    <thead>
        <tr>
            <th>品目</th>
            <th>カテゴリー</th>
            <th>総在庫</th>
            <th>予約割当</th>
            <th>入荷待ち</th>
            <th>可用在庫</th>
            <th>単位</th>
            <th>発注フラグ</th>
            <th>入庫</th>
            <th>出庫</th>
        </tr>
    </thead>
    <tbody id="stock-table">
        <!-- データは JS で動的に追加 -->
    </tbody>
</table>


<script>
async function loadStock() {
    const res = await fetch("/stock");
    const stock = await res.json();
    const tbody = document.getElementById("stock-table");
    tbody.innerHTML = ""; // 既存行をクリア

    stock.forEach(inv => {
        const tr = document.createElement("tr");

        // 発注フラグや予約割当・入荷待ちで色分け
        if (inv.reorder_flag) tr.style.backgroundColor = "#ffcccc";  // 赤
        else if (inv.allocated > 0) tr.style.backgroundColor = "#fff0b3"; // 黄
        else if (inv.ordered > 0) tr.style.backgroundColor = "#cce5ff"; // 青

        tr.innerHTML = `
            <td>${inv.item_name}</td>
            <td>${inv.category}</td>
            <td>${inv.quantity}</td>
            <td>${inv.allocated}</td>
            <td>${inv.ordered}</td>
            <td>${inv.available}</td>
            <td>${inv.unit}</td>
            <td>${inv.reorder_flag ? "⚠️" : ""}</td>
            <td><button onclick="stockIn(${inv.inventory_id})">入庫</button></td>
            <td><button onclick="stockOut(${inv.inventory_id})">出庫</button></td>
            <td><button onclick="createReservation(${inv.inventory_id})">予約作成</button></td>

        `;
        tbody.appendChild(tr);
    });
}

async function stockIn(inventory_id) {
    const qty = prompt("入庫数量を入力:");
    if (!qty) return;
    await fetch("/stock/in", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({inventory_id, qty: parseInt(qty)})
    });
    loadStock();
}

async function stockOut(inventory_id) {
    const qty = prompt("出庫数量を入力:");
    if (!qty) return;
    await fetch("/stock/out", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({inventory_id, qty: parseInt(qty)})
    });
    loadStock();
}
async function createReservation(inventory_id) {
    const qty = prompt("予約数量を入力:");
    if (!qty) return;
    const usage = prompt("用途や顧客名を入力（任意）:", "");
    const res = await fetch("/reservation/create", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({inventory_id, qty: parseInt(qty), usage})
    });
    const data = await res.json();
    if (data.status === "ok") {
        alert("予約作成成功");
        loadStock();
    } else {
        alert("エラー: " + data.message);
    }
}


// ページ読み込み時に在庫をロード
window.onload = loadStock;
</script>
